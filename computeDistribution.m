clear
B1=4;
B2=4;
k=6;
v=10;
lambda1=0.6;
lambda2=0.2;
ls=(k+v); %liczba slotów

%dane z symulacji
%system 
%TA/TV=6/10, B1/B2=4/4, lambda1=0.6, lambda2=0.2
x=[[[192781 59134 10352 1391 145 ];[177053 62074 11951 1634 202 ];[112922 43738 9182 1263 159 ];[68794 29432 6425 991 157 ];[34657 15217 3446 573 77 ]];[[192475 71207 16276 2913 482 ];[166205 72454 18937 3578 583 ];[96401 50099 14575 2921 566 ];[50420 29370 8949 1932 387 ];[22956 14331 4544 993 196 ]];[[192657 78453 21590 4785 1052 ];[159133 78252 25020 5945 1357 ];[83514 50853 18198 4746 1178 ];[38898 27776 10600 2932 753 ];[16419 12706 5166 1396 371 ]];[[193598 83581 26305 6880 1796 ];[153648 80535 29025 8614 2353 ];[74554 49058 20425 6407 1992 ];[31439 25097 11623 3756 1235 ];[12813 11225 5419 1817 555 ]];[[193900 86413 29394 9050 2774 ];[149808 80772 31911 10741 3628 ];[69079 47045 21818 7741 2845 ];[27189 22776 11991 4409 1714 ];[10510 10010 5285 2135 812 ]];[[193734 88231 32140 11049 3903 ];[146592 80362 33899 12508 4833 ];[66095 44664 22235 8737 3621 ];[24415 21203 11721 4958 2224 ];[9033 8934 5319 2270 1070 ]];[[192925 52653 11647 3215 512 ];[182079 59842 16915 5721 951 ];[104967 43035 14618 5432 929 ];[51118 24229 9705 3993 671 ];[29336 17486 7765 3382 624 ]];[[192168 43348 6241 919 93 ];[189795 48814 9311 1666 259 ];[121589 36084 8957 1996 299 ];[69362 23650 7345 1615 251 ];[47938 21436 8149 2189 276 ]];[[190904 41219 4880 420 46 ];[190973 43889 5974 689 73 ];[127861 32708 5410 808 108 ];[81791 22771 4355 722 84 ];[58800 22013 5919 1192 141 ]];[[189914 40517 4418 349 19 ];[191528 42039 5052 469 41 ];[131640 30688 4022 422 45 ];[88435 21945 3108 351 49 ];[63979 19978 4009 664 69 ]];[[189507 40220 4329 325 24 ];[191279 41740 4835 431 24 ];[134659 30589 3747 325 31 ];[91709 21218 2708 295 31 ];[64413 17890 2991 393 37 ]];[[189268 39710 4346 324 31 ];[192556 42105 4643 424 31 ];[136466 30602 3741 322 31 ];[92826 21457 2753 254 21 ];[62462 16592 2451 308 26 ]];[[189384 40067 4339 332 27 ];[193518 41916 4821 409 23 ];[138356 30441 3694 302 26 ];[92114 21018 2683 241 27 ];[61582 15753 2394 256 27 ]];[[189848 40234 4408 359 18 ];[194942 42094 4828 365 23 ];[138257 30818 3647 336 32 ];[91436 21016 2639 255 22 ];[60210 15462 2224 254 23 ]];[[191257 40149 4327 344 18 ];[195390 42275 4920 391 18 ];[137198 31186 3734 327 27 ];[91402 20917 2612 240 21 ];[59129 15433 2173 244 18 ]];[[191807 40206 4431 329 31 ];[196203 42386 4815 397 31 ];[138169 30739 3762 323 21 ];[90249 20552 2574 226 13 ];[58971 15128 2123 239 25 ]]];
%TA/TV=6/10, B1/B2=7/7, lambda1=0.6, lambda2=0.2
%x=[[[174513 53579 9344 1272 121 13 1 0 ];[159348 55804 10605 1486 163 16 2 0 ];[100044 38773 8141 1141 132 12 0 1 ];[60335 25381 5507 794 93 15 2 0 ];[38480 16362 3684 547 76 12 3 0 ];[25092 10797 2394 372 42 1 1 0 ];[16575 7297 1589 261 43 4 0 0 ];[8658 3820 832 151 17 2 0 0 ]];[[173771 64090 14623 2600 362 55 7 0 ];[149321 64872 16898 3224 482 49 7 1 ];[85744 44139 12771 2552 387 58 7 1 ];[48236 28027 8651 1785 304 53 8 0 ];[28893 17968 5654 1231 206 31 6 0 ];[18787 11743 3725 801 133 20 4 0 ];[11166 6977 2219 526 87 13 2 0 ];[5471 3607 1112 231 46 6 0 0 ]];[[173263 70548 19391 4290 834 118 18 2 ];[143104 69785 22022 5276 1011 149 27 1 ];[76294 46235 16632 4335 877 133 20 3 ];[39203 28586 11148 3025 601 130 26 1 ];[22397 17840 7265 2016 439 82 10 2 ];[13570 11110 4558 1286 283 55 8 1 ];[7642 6240 2576 719 169 28 5 0 ];[3569 3027 1308 365 68 22 2 0 ]];[[174158 74840 23356 6097 1334 248 47 10 ];[138627 72667 26311 7648 1780 333 61 9 ];[68962 46360 19519 6089 1495 331 63 9 ];[33152 27355 12820 4158 1066 219 37 7 ];[17728 16505 8234 2846 725 162 24 3 ];[9813 9833 4958 1729 456 99 15 4 ];[5251 5219 2825 1001 259 56 11 1 ];[2418 2510 1304 431 123 31 7 1 ]];[[174519 77607 26491 7972 2089 438 91 17 ];[135641 73928 29492 9801 2688 635 126 21 ];[64981 45346 21650 7668 2241 549 125 17 ];[28534 25839 13909 5229 1557 380 87 14 ];[13860 14994 8642 3480 1071 252 62 12 ];[7309 8312 5048 2093 638 160 39 10 ];[3767 4450 2689 1110 348 106 15 4 ];[1607 2005 1235 520 170 54 5 1 ]];[[174523 80044 29486 9810 2918 788 169 39 ];[133652 74163 31868 11810 3650 940 224 61 ];[62175 44094 22542 9078 2919 857 175 40 ];[25269 23996 14338 6179 2103 590 121 41 ];[11198 13202 8476 3991 1371 402 114 23 ];[5571 7157 4888 2337 788 223 60 17 ];[2554 3591 2491 1158 414 146 34 6 ];[1157 1665 1221 538 207 75 12 1 ]];[[174820 47869 10515 2641 736 172 42 2 ];[166633 55039 15532 4763 1302 340 87 18 ];[99098 41208 14247 4662 1423 349 82 15 ];[51894 25518 10554 3752 1142 282 81 12 ];[26774 15528 6958 2553 831 218 61 15 ];[13784 8901 4258 1669 533 148 39 4 ];[7039 4788 2410 932 321 108 18 1 ];[4568 3559 1816 739 259 73 14 1 ]];[[174914 39456 5587 934 176 34 2 2 ];[174746 44802 8119 1723 435 115 21 3 ];[114835 34281 8100 2188 593 157 34 5 ];[67126 23429 6891 1931 539 149 25 4 ];[38476 14936 4930 1519 447 105 34 6 ];[21289 9202 3172 1130 298 97 15 2 ];[12134 5430 1906 688 195 65 11 2 ];[8558 4770 1968 710 237 56 6 0 ]];[[174704 37536 4526 449 55 5 3 0 ];[176491 40316 5516 767 143 23 9 2 ];[120218 30442 5226 1000 267 54 8 2 ];[74598 20818 4270 959 228 45 7 0 ];[44697 13827 3304 862 214 75 20 1 ];[26474 8604 2349 646 196 32 5 0 ];[16303 5585 1539 439 110 27 4 0 ];[12098 5073 1767 601 172 31 8 0 ]];[[174422 37238 4082 339 24 3 0 0 ];[177162 38941 4779 464 55 9 2 0 ];[121762 28496 3877 519 88 18 3 1 ];[77252 19388 3056 498 109 16 5 0 ];[47836 12724 2364 467 99 35 2 1 ];[29479 8329 1592 360 110 17 3 0 ];[19233 5591 1152 278 52 13 1 0 ];[14159 5190 1509 407 109 28 2 0 ]];[[174642 36942 3995 310 21 3 0 0 ];[176488 38734 4444 410 28 4 1 0 ];[122363 28117 3525 354 37 4 2 0 ];[78035 18492 2513 342 51 8 2 0 ];[49193 12215 1854 258 62 12 2 0 ];[31497 7796 1304 210 46 5 1 0 ];[21039 5400 917 157 37 6 0 0 ];[15467 4891 1171 264 69 7 2 1 ]];[[174298 36626 4029 295 30 1 0 0 ];[177151 38673 4260 400 30 1 0 0 ];[122454 27472 3399 320 30 3 0 0 ];[78472 18248 2412 238 27 8 0 0 ];[49932 11993 1628 213 27 3 0 0 ];[31934 7923 1078 154 25 6 0 0 ];[22171 5544 782 124 12 3 1 0 ];[15601 4599 899 183 31 6 1 0 ]];[[174146 36933 4013 306 25 1 0 0 ];[176876 38293 4392 368 22 2 0 0 ];[123059 27090 3371 277 17 4 0 0 ];[78279 18107 2342 210 31 4 0 0 ];[50464 11565 1543 167 15 1 0 0 ];[33285 7879 1039 137 17 3 1 0 ];[22480 5362 759 87 10 3 0 0 ];[15582 4271 786 97 24 5 0 0 ]];[[174158 37006 4062 334 19 0 0 0 ];[176841 38295 4395 331 19 1 0 0 ];[122595 27345 3272 302 27 3 0 0 ];[78478 17983 2246 220 19 3 0 0 ];[50855 11874 1540 151 16 1 0 0 ];[33473 7776 1007 114 6 1 0 0 ];[22508 5394 686 71 9 4 0 0 ];[15389 4135 676 90 18 2 0 0 ]];[[174577 36638 3945 312 16 0 0 0 ];[176378 38307 4481 354 14 1 1 0 ];[122168 27683 3261 295 24 1 0 0 ];[78974 18094 2269 211 19 3 0 0 ];[50981 12095 1584 154 11 2 0 0 ];[33715 7827 989 106 9 0 0 0 ];[22473 5382 695 62 8 0 0 0 ];[14940 4004 602 73 11 1 0 0 ]];[[174222 36448 4050 291 28 1 0 0 ];[176799 38362 4336 373 26 3 0 0 ];[123118 27236 3321 289 17 0 0 0 ];[78932 18081 2293 208 10 2 0 0 ];[51014 11922 1520 142 21 3 0 0 ];[33758 8002 1025 90 6 0 0 0 ];[22389 5164 656 68 8 0 0 0 ];[15083 3832 528 66 7 0 0 0 ]]];
%TA/TV=6/10, B1/B2=4/2, lambda1=0.6, lambda2=0.2
%x=[[[195716 60112 11731 ];[178622 62600 13449 ];[112540 43591 10171 ];[67359 28783 6966 ];[33727 14687 3696 ]];[[194960 72572 18836 ];[167562 73149 22406 ];[96039 49850 17340 ];[49639 28868 10668 ];[22516 13939 5406 ]];[[195013 80319 25552 ];[160342 79355 30799 ];[83520 50768 23125 ];[38584 27403 13725 ];[16139 12492 6614 ]];[[196016 86279 31576 ];[155119 82257 37272 ];[74846 49282 27512 ];[31329 25011 15988 ];[12686 11089 7488 ]];[[196818 90147 35746 ];[151782 83107 42270 ];[69625 47826 30615 ];[27203 22833 17377 ];[10484 9969 7948 ]];[[197651 92936 39284 ];[149198 83462 45774 ];[66903 45806 32243 ];[24593 21426 18088 ];[9057 8966 8363 ]];[[198039 56738 8071 ];[186835 68143 10805 ];[107542 51742 8912 ];[51996 31203 5797 ];[29708 23635 4584 ]];[[198468 42977 5031 ];[198378 46687 5810 ];[129947 33306 4425 ];[76489 21184 2966 ];[56861 18484 2737 ]];[[197403 41959 4812 ];[197836 43336 5092 ];[132581 30544 3732 ];[86490 20313 2516 ];[59444 15531 2161 ]];[[196254 41692 4667 ];[197192 42759 5005 ];[135021 30451 3553 ];[88918 20752 2443 ];[58358 14814 1871 ]];[[195425 41546 4618 ];[196616 42857 5025 ];[137034 30850 3649 ];[89286 20236 2461 ];[57756 14552 1839 ]];[[194818 41022 4647 ];[197661 43258 4907 ];[137508 30785 3757 ];[89164 20690 2510 ];[56806 14396 1821 ]];[[194783 41310 4648 ];[197688 42876 5000 ];[138454 30608 3670 ];[88565 20315 2535 ];[57142 14209 1947 ]];[[194710 41309 4727 ];[198430 42948 4959 ];[137853 30823 3669 ];[88364 20334 2533 ];[56829 14386 1876 ]];[[195478 41126 4603 ];[198107 42979 5123 ];[136764 31181 3694 ];[88868 20428 2478 ];[56511 14565 1845 ]];[[195452 41038 4670 ];[198409 42938 5027 ];[137555 30751 3748 ];[88504 20194 2414 ];[56842 14387 1821 ]]];

%obróbka wyników symulacyjnych
%obliczam rozk³ad stanu kolejek z liczby wyst¹pieñ stanu
nr=1;
for i=1:ls
    for j=1:(B1+1)
        xs(i,j,:)=x(nr,:); %(slot, Q0, Q1)
    nr=nr+1;
    end
end
for i=1:ls
    suma=sum(sum(xs(i,:,:)));
    xs(i,:,:)=xs(i,:,:)/suma;
end
format short
%rozk³ad stanu w 1 szczelinie
x1(:,:)=xs(1,:,:);

%tworzy macierz symboli (stany p00, p01..., pYZ)
p=sym('p%d%d',[B1+1 B2+1]);
pn=[];
%zmieniam macierz na wektor <- jeden wymiar
for i=1:B1+1
    pn=[pn p(i,:)];
end
p=pn;

for i=1:(B1+1)*(B2+1)
     assume(p(i), 'positive');
 end

%uzupe³niam w macierzach M1 i M2 p. przejœcia miêdzy stanami dla fazy 1 i 2 (ró¿ne priorytety obs³ugi)
%getProbability(n,m,k,l,B1,B2,lambda1, lambda2, AV) %AV =1-faza 1; 2-faza 2
M1=zeros((B1+1)*(B2+1));
M2=zeros((B1+1)*(B2+1));
for i=1:(B1+1)*(1+B2)
    for j=1:(B1+1)*(1+B2)
        n=floor((i-1)/(B2+1));
        m=mod(i-1,(B2+1));
        k=floor((j-1)/(B2+1));
        l=mod(j-1,(B2+1)) ;
        M1(i,j)=getProbability(n,m,k,l,B1,B2,lambda1,lambda2,1);
        M2(i,j)=getProbability(n,m,k,l,B1,B2,lambda1,lambda2,2);
    end
end

MW=M1^k*M2^v; %macierz zastêpcza, przejœcie po cyklu -> k szczelin fazy 1 i v szczelin fazy 2 
eq3=p==p*MW; %uk³ad równañ - stacjonarnoœæ
eq3((B1+1)*(B2+1))=sum(p)==1;
res=solve(eq3);
PA=zeros(B1+1,B2+1);
for i=1:B1+1
    for j=1:B2+1
     str=strcat('p',int2str(i),int2str(j));
     PA(i,j)=double(res.(str));
    end
end
%zmieniam macierz na wektor
pn=[];
for i=1:B1+1
    pn=[pn PA(i,:)];
end
px0=pn;
px1=px0*M1;
px1=vectorToMatrix(px1,B2+1);

%obliczam rozk³ady dla obu strumieni z rozk³adu dwuwymiarowego:
%szczelina 1
P1=[1:B1+1];
for i=1:B1+1
   P1(i)=sum(px1(i,:));
end
P2=[1:B2+1];
for j=1:B2+1
   P2(j)=sum(px1(:,j));
end
%rozk³ad stanów z symulacji
x1
%rozk³ad stanów obliczony
px1
%rozk³ad stanów - strumieñ 1
P1   
%rozk³ad stanów - strumieñ 2
P2